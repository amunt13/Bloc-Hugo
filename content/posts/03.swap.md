+++
title = 'Swap'
date = 2025-11-04T07:06:43+01:00
draft = false
math = true
+++

Això és una reflexió sobre la Swap sorgida com a conseqüència del xifrat que vaig fer d'un ordinador portàtil. 

En aquestes circumstàcies has de posar la contrasenya tantes vegades com particions xifris. I això no és còmode. El primer que se t'acudeix és agrupar-ho tot a la partició arrel. És a dir, parteixes d'un esquema /boot, / i swap. /boot no pot anar encriptada a l'arrencada. / és l'objecte de l'encriptació. Swap és el tema què ens ocupa, ja que pot contenir informació sensible. 

Així que el tema és com evitar de posar la contrasenya dues vegades, per a la partició arrel i per a la swap. He de dir que he trobat dues solucions. Fer un xifrat automàtic de la ram i l'altra, eliminar-la.

## Una solució: xifrat automàtic de la swap.

Aquesta solució me la va donar la IA quan estava instal·lant FreeBSD a un portàtil. Es tracta de dir-li al sistema que xifrii la swap a l'arrencada amb Geli. Per fer-ho fes el següent:

1. Desactiva la wap `swapoff -a`.

2. Encripta la partició swap amb una contrassenya temporal: `geli onetime /dev/your-swap-partition`. Per identificar la partició pots utilitzar l'ordre `gpart show`.

3. Activa la swap encriptada: `swapon /dev/your-swap-partition.eli`.

4. Activa el mòdul a l'arrencada: Afegeix `"geom\_eli\_load="YES"` a `/boot/loader.conf`.

5. Configura `/etc/fstab`: Canvia la línia correponent a la swap per afegir el sufix `eli`. Per exemple, `/dev/ada0p4.eli` en lloc de `/dev/ada0p4`.

6. Reinicia el sistema. Es crearà automàticament una clau temporal per encriptar la swap a cada inici.

D'aquesta manera la swap quedarà encriptada i no necessitaras introduïr cap altra contrassenya. Pots verificar l'estat de la swap amb l'ordre `swapinfo`. Si tot és correcte, la sortida tindrà un sufix `.eli`com per exemple `/dev/ada0p4.eli`.

Sembla que a Linux també es pot fer, però amb eines diferents. He llegit que  Debian i Ubuntu ho duen incorporat, però jo no he vist com fer-ho.

## No crear partició swap.

Pel què he llegit això es pot aconseguir de dues maneres, enviant la swap a un fitxer o creant la zram. Ara parlaré de la zram.

És la solució que aporta Fedora per defecte en la instal·lació de la versió workstation, que és la que vaig provar. Suprimeix la ram perquè n'amplia la física existent en base a un procés de compressió. Es pot usar sense swap o també amb ella creant un sistema mixt. És evident que si vols evitar el posar la contrasenya per a la swap, el correcte és eliminar-la.

És una tecnologia antiga I molt eficient. La zram comprimeix la ram de forma dinàmica a costa de l'ús de la CPU. La pèrdua de rendiment per aquest motiu és molt menor que la que provoquen les lectures- escriptures a la swap física. El fet que sigui una eina dinàmica vol dir que realment l’us de la zram s’inicia pràcticament en el mateix moment en el què es faria ús de la swap física. Es a dir, realment l’aplicació de la zram no redueix la ram física disponible, encara que en tingui una part reservada. Quan es necessita la paginació, s’activa la zram i sempre de forma prioritaria davant la possible existència de partició swap. 
Es una solució molt bona per evitar la necessitat de tenir swap (sistemes live o evitar xifrar la swap). També és una estratègia de mantenir un bon rendiment del PC en situacions de molta demanda de ram i d’evitar escriptures al disc que danyen les ssd.
Es molt fàcil d’habilitar:

`sudo apt install zram-tools`

`echo -e "ALGO=zstd\nPERCENT=60" | sudo tee -a /etc/default/zramswap`

(això modifica la configuració per defecte, indicant el tipus de compresió, zstd -la mes eficient-, i percentatge de la ram total disponible per la zram).

`sudo service zramswap reload`

`sudo swapon –show` (Per veure com esta la swap).

## Reflexió final sobre la swap:

Deixant clar que no estem parlant d'ordinadors amb un ús crític i que la memòria ram no és cara, puc fer la següent reflexió: 

1. Si necessites hivernar el PC, crea una partició swap. Les recomanacions van des del mateix tamany de la ram, fins al doble. Per a màquines amb quantitats considerables de ram, les actuals, Fedora recomana un tamany $ x + \sqrt{x} $, essent $ x $ el tamany de la ram física.

2. En cas contrari, evita la partició swap i crea zram,especialment en ordinadors portàtils xifrats.

